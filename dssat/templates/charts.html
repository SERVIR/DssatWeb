<html lang="en">
{% load static %}
<head>
    <title>DSSAT-Web</title>
    <link rel="stylesheet" href="{% static 'css/style.css' %}"/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
          integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.min.js"
            integrity="sha384-BBtl+eGJRgqQAUMxJ7pMwbEyER4l1g+O15P+16Ep7Q9Q+zqX6gSbd85u4mG4QzX+"
            crossorigin="anonymous"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>

    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>

    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script src="https://code.highcharts.com/highcharts-more.js"></script>

    <script src="https://code.highcharts.com/modules/streamgraph.js"></script>
    <script src="https://code.highcharts.com/modules/series-label.js"></script>
    <script src="https://code.highcharts.com/modules/annotations.js"></script>
    {% comment %} <script src="https://code.highcharts.com/modules/exporting.js"></script> {% endcomment %}
    <script src="https://code.highcharts.com/modules/export-data.js"></script>
    <script src="https://code.highcharts.com/modules/no-data-to-display.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/js/all.min.js" integrity="sha512-6sSYJqDreZRZGkJ3b+YfdhB3MzmuP9R7X1QZ6g5aIXhRvR1Y/N/P47jmnkENm7YL3oqsmI6AK+V6AD99uWDnIw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" integrity="sha512-Kc323vGBEqzTmouAECnVceyQqyqdsSiqLQISBL29aUW4U/M7pSPA/gEUZQqv1cwx4OnYxTxve5UMg5GT6L4JJg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="{% static 'js/utils.js' %}"></script>
    <style>
        abbr {
    position: relative;
}
abbr:hover::after {
    content: attr(data-title);
    position: absolute;
    width: 300px;
    left: 100%;
    display: block;
    padding: 0.5em;
    background: white;
    color:black;
    border: solid black 1px;
    z-index: 1000;
}
    </style>
</head>

<body>
  <script>
    var cultivar_types={{ cultivar_types|safe }};
    var cultivar_codes={{ cultivar_codes|safe }};
    var admin1='{{ admin1|safe }}';
    var admin1_country='{{ admin1_country|safe }}';
  </script>

  <nav class="navbar navbar-expand-lg navbar-light" style="background-color: darkolivegreen;height: 70px">
    <div class="container-fluid">
        <a class="navbar-brand" href="{% url 'home' %}">
          <img src="{% static 'img/SERVIR_flat_white2.png' %}" alt="SERVIR logo" style="height:40px; max-width: none;">
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <h3 style="display: inline; color: white; margin: auto; text-align: center; width: 100%;">
          Dssat Web App : V1
        </h3>
        <div class="collapse navbar-collapse d-flex justify-content-end" id="navbarNav">
        <ul class="navbar-nav">
          <li class="nav-item">
            <a class="nav-link text-light" aria-current="page" href="{% url 'home' %}">Map</a>
          </li>
          <li class="nav-item">
            <a class="nav-link text-light" href='{% url 'about' %}'>About</a>
          </li>
        </ul>
      </div>
    </div>
  </nav>
  <div id="blur_div" style="position: fixed; background: #ffffffa6; overflow: hidden; display: none; /* z-index: 999; */ z-index: 500; inset: 0">
  </div> 
  <button class="btn btn-success" type="button" disabled id="spinner_button" style="position: fixed; top: 50%; left: 50%; z-index: 999;display: none;">
    <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
    Running simulations...
  </button>

  <div class="col mx-auto charts_column">
    <h4 class="mt-2">
      Maize yield forecast details in <span id="admin1">{{admin1}}</span>
    </h4>
    <p>

    </p>
    <div class="forecast_box">
      {% comment %} <h5> 
        Maize yield forecast details
      </h5> {% endcomment %}
      <p>
        This forecast was generated by simulating the crop season multiple times under different conditions. Such conditions represent the soil and weather variability within <span id="admin1">{{admin1}}</span>. Therefore, the forecast is conformed by multiple values that are a result of simulating one season for different soil and weather conditions in the region.
      </p>
      <h6>
        The plots below sumarize the results of the forecast. The left hand side plot shows the distribution of the simulated yield values. The right hand side plot shows the crop water and nitrogen fertilizer stress during the season across different phenological stages.
      </h6>
      <div class="row">
        <div class="col-md-3" id="forecast_chart"></div>
        <div class="col-md-9" id="forecast_stress_chart"></div>
      </div>
      <br> 
      <div>
        <div class="d-flex">
          <div class="mx-auto">
            <h6 style="text-align: center;">
              For further details on the forecast, click the buttons:
            </h6>
            <button class="btn btn-info m-auto" onclick="location.href='#popup-box';">
              How to interpret the plots
            </button>
            <button class="btn btn-info m-auto" onclick="">
              How reliable is the model
            </button>
          </div>
        </div>
      </div>
    </div>

    <div id="popup-box" class="modal">
      <div class="popup-content">
        <img src="/static/img/Plot_interpretation.png" alt="SERVIR Global" style="max-height: 800px;">
        <a href="#" style="position: absolute; top: 10px; right: 10px; color: #fe0606; font-size: 30px; text-decoration: none;">&times;</a>
      </div>
    </div>

    <h4 class="mt-2">
      Explore your own simulation scenarios
    </h4>
    <div style="border:darkgray 1px solid;border-radius: 10px;padding: 10px;margin-bottom: 30px;">
      {% comment %} </div> {% endcomment %}
      <p>
        You can run the model and produce a forecast with the management scenario that you define. Select the managment parameters, and then click the Run Simulation button. Each time you run a new simulation, the results will be added to the chart. To clean the charts click the Clean Chart button.
      </p>
      <div class="parameters-box">
        <h5 style="text-align: center">Select crop management parameters</h5>
        <div class="row">
          <div class="col-md-6" style="padding: 15px">
            <div class="row">
              <div class="col-md-6">
                <label for="startDate">
                  <abbr data-title="The date the crop was or will be planted."><i class="fa fa-info-circle" aria-hidden="true"></i></abbr>
                  Planting date 
                </label>
              </div>
              <div class="col-md-6">
                <input id="startDate" class="form-control" type="date"/>
              </div>
            </div>
            <div class="row">
              <div class="col-md-6">
                <label for="cultivar">
                  <abbr data-title="Crop maturity type"> <i class="fa fa-info-circle" aria-hidden="true"></i></abbr>
                  Cultivar
                </label>
              </div>
              <div class="col-md-6">
                <select id="cultivar" class="form-select"></select>
              </div>
            </div>
            <div class="row">
              <div class="col-md-6">
                <label for="irrigation">
                  <abbr data-title="Select if irrigation is applied as needed, or if no irrigation is applied"> <i class="fa fa-info-circle" aria-hidden="true"></i></abbr>
                  Irrigation
                </label>
              </div>
              <div class="col-md-6">
                <select name="irrigation" id="irrigation", class="form-select" disabled>
                  <option value="yes">Apply Irrigation as needed</option>
                  <option value="no" selected>Don't apply irrigation</option>
                </select>
              </div>
            </div>
              
          </div>
          <div class="col-md-6" style="padding: 15px">
            <div>
              <abbr data-title=" Nitrogen fertilizer applications. Each application is defined by the application day (days after planting) and the application rate (Kg of Nitrogen per hectare). Use the add button to add a new application."><i class="fa fa-info-circle" aria-hidden="true"></i></abbr>
              Nitrogen Fertilizer
              <table class="table table-bordered" id="nitrogen_table">
                <thead>
                  <tr>
                    <th>Days after planting</th>
                    <th>Rate (Kg N/ha)</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td>
                      <input type="number"  class="w-75 h-50 form-control" id="nitro_dap" min="0" max="200"/>
                    </td>
                    <td>
                      <input type="number" id="nitro_rate" class="w-75 h-50 form-control" min="0" max="999"/>
                    </td>
                    <td>
                      <button class="btn btn-outline-success" onclick="addToBox()">
                        <i class="fa fa-plus-square" aria-hidden="true"></i>
                      </button>
                    </td>
                  </tr>
                  <tr></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
        <div class="d-flex justify-content-center">
          <button class="btn btn-success m-1" onclick="generate_charts()">
            Run experiment
          </button>
          <button class="btn btn-dark m-1" onclick="clear_charts()">
            Clear charts
          </button>
        </div>
      </div>
      
      <div id="charts_container", style="display:none">
        <div id="column_chart"></div>
        <div class="row">
          <div class="col-6" id="stress_chart_water"></div>
          <div class="col-6" id="stress_chart_nitrogen"></div>
        </div>
      </div>
    </div>
  </div>
  <footer id="footer">
    <div class="ml-auto footer" style="height:50px">
      <div class="d-flex align-items-center justify-content-between h-100">
        <a href="https://servirglobal.net">
          <img src="/static/img/servir_global_full_logo_white.png" alt="SERVIR Global" style="margin-left: 8px; max-height: 21px;">
        </a>
      </div>
    </div>
  </footer> 
  <script src="{% static 'js/charts.js' %}"></script>
  <script src="{% static 'highcharts_config/baseline_template.js' %}"></script>
  <script id="charts">
    {{ forecast_chart|safe }}
    {{ forecast_stress_chart|safe }}
    {{ new_chart|safe }}
    {{ range_chart|safe }}
    {{ anomaly_chart|safe }}
    {{ stress_chart_water|safe }}
    {{ stress_chart_nitrogen|safe }}
  </script>
</body>
</html>